// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Location {
  id          String   @id @default(cuid())
  name        String
  description String?
  latitude    Float
  longitude   Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("locations")
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  name              String
  password          String?             // For email/password auth (hashed)
  avatar            String?
  provider          String?             // 'google', 'facebook', 'email', or 'test'
  providerId        String?             // OAuth provider's user ID
  refreshToken      String?             @db.Text
  groqApiKey        String?             // User's personal Groq API key
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  catches           Catch[]
  sentRequests      Friendship[]        @relation("FriendRequester")
  receivedRequests  Friendship[]        @relation("FriendAccepter")
  likes             Like[]
  comments          Comment[]
  ownedEvents       Event[]
  eventParticipants EventParticipant[]
  badges            UserBadge[]
  validatedCatches  CatchValidation[]
  ownedClubs        Club[]
  clubMemberships   ClubMember[]
  clubMessages      ClubMessage[]
  groupMemberships  GroupMembership[]
  groupPosts        GroupPost[]
  groupPostLikes    GroupPostLike[]
  groupPostComments GroupPostComment[]
  groupMessages     GroupMessage[]
  favoriteSpots     FavoriteSpot[]
  trips             Trip[]
  tripParticipants  TripParticipant[]
  gear              Gear[]
  licenses          FishingLicense[]
  streaks           Streak[]
  notifications     Notification[]
  ownedChallenges   Challenge[]       @relation("ownedChallenges")
  challengeParticipants ChallengeParticipant[] @relation("challengeParticipants")
  challengeComments ChallengeComment[]
  sentMessages      Message[]         @relation("sentMessages")
  receivedMessages  Message[]         @relation("receivedMessages")
  personalBests     PersonalBest[]

  @@unique([provider, providerId])
  @@map("users")
}

model Catch {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  species    String?
  lengthCm   Float?
  weightKg   Float?
  bait       String?
  lure       String?
  rig        String?
  technique  String?
  notes      String?   @db.Text
  latitude   Float?
  longitude  Float?
  photoUrl      String?
  photoHash     String?   // SHA-256 hash of image for verification
  exifData      String?   @db.Text // JSON: timestamp, GPS, device model, etc.
  isDraft       Boolean   @default(true) // true = incomplete, false = completed
  visibility    String    @default("private") // 'private', 'friends', 'public'
  createdAt     DateTime  @default(now())
  updatedAt     DateTime        @updatedAt
  likes         Like[]
  comments      Comment[]
  validations   CatchValidation[]
  clubMessages  ClubMessage[]
  groupPosts    GroupPost[]
  groupMessages GroupMessage[]
  weatherData   WeatherData?

  @@index([userId])
  @@index([isDraft])
  @@map("catches")
}

model Fish {
  id        String   @id @default(cuid())
  species   String
  weight    Float?
  length    Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fish")
}

model Friendship {
  id          String   @id @default(cuid())
  requesterId String
  accepterId  String
  status      String   @default("pending") // 'pending', 'accepted', 'rejected'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  requester   User     @relation("FriendRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  accepter    User     @relation("FriendAccepter", fields: [accepterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, accepterId])
  @@index([requesterId])
  @@index([accepterId])
  @@map("friendships")
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  catchId   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  catch     Catch    @relation(fields: [catchId], references: [id], onDelete: Cascade)

  @@unique([userId, catchId])
  @@index([catchId])
  @@map("likes")
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  catchId   String
  text      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  catch     Catch    @relation(fields: [catchId], references: [id], onDelete: Cascade)

  @@index([catchId])
  @@map("comments")
}

model Event {
  id            String              @id @default(cuid())
  ownerId       String
  title         String
  description   String?             @db.Text
  startAt       DateTime
  endAt         DateTime
  venue         String?
  visibility    String              @default("public") // 'private', 'friends', 'public'
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  owner         User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  contests      Contest[]
  participants  EventParticipant[]

  @@index([ownerId])
  @@index([startAt])
  @@map("events")
}

model Contest {
  id            String   @id @default(cuid())
  eventId       String
  rule          String   // 'biggest_total', 'biggest_single', 'most_catches'
  speciesFilter String?  // Filter by specific species, null = all species
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("contests")
}

model EventParticipant {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  joinedAt  DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_participants")
}

model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  description String      @db.Text
  icon        String      // Emoji or icon identifier
  rule        String      // Rule type: 'first_catch', 'catch_count_10', 'biggest_fish_5kg', etc.
  ruleData    String?     @db.Text // JSON data for rule parameters
  tier        String      @default("bronze") // 'bronze', 'silver', 'gold', 'platinum'
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  progress  Int?     // For progressive badges (e.g., 7 out of 10 catches)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

model CatchValidation {
  id          String   @id @default(cuid())
  catchId     String   @map("catch_id")
  catch       Catch    @relation(fields: [catchId], references: [id], onDelete: Cascade)
  validatorId String   @map("validator_id")
  validator   User     @relation(fields: [validatorId], references: [id])
  status      String   // 'approved' or 'rejected'
  reason      String?  @db.Text
  validatedAt DateTime @default(now()) @map("validated_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([catchId])
  @@index([validatorId])
  @@map("catch_validation")
}

model Club {
  id          String        @id @default(cuid())
  name        String
  description String?       @db.Text
  ownerId     String        @map("owner_id")
  owner       User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  avatar      String?
  visibility  String        @default("private") // 'private', 'public'
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  members     ClubMember[]
  messages    ClubMessage[]

  @@index([ownerId])
  @@map("clubs")
}

model ClubMember {
  id       String   @id @default(cuid())
  clubId   String   @map("club_id")
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId   String   @map("user_id")
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role     String   @default("member") // 'owner', 'admin', 'member'
  joinedAt DateTime @default(now()) @map("joined_at")

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
  @@map("club_members")
}

model ClubMessage {
  id        String   @id @default(cuid())
  clubId    String   @map("club_id")
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  senderId  String   @map("sender_id")
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  message   String?  @db.Text
  imageUrl  String?  @map("image_url")
  catchId   String?  @map("catch_id")
  catch     Catch?   @relation(fields: [catchId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([clubId, createdAt])
  @@index([senderId])
  @@map("club_messages")
}

model Group {
  id          String            @id @default(cuid())
  name        String
  description String?           @db.Text
  logoUrl     String?           @map("logo_url")
  isPrivate   Boolean           @default(false) @map("is_private")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  members     GroupMembership[]
  posts       GroupPost[]
  messages    GroupMessage[]

  @@index([isPrivate])
  @@map("groups")
}

model GroupMembership {
  id        String   @id @default(cuid())
  groupId   String   @map("group_id")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("MEMBER") // 'ADMIN', 'MEMBER'
  status    String   @default("PENDING") // 'PENDING', 'APPROVED'
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([status])
  @@map("group_memberships")
}

model GroupPost {
  id        String             @id @default(cuid())
  groupId   String             @map("group_id")
  group     Group              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String             @map("user_id")
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String?            @db.Text
  catchId   String?            @map("catch_id")
  catch     Catch?             @relation(fields: [catchId], references: [id], onDelete: SetNull)
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")
  likes     GroupPostLike[]
  comments  GroupPostComment[]

  @@index([groupId, createdAt])
  @@index([userId])
  @@map("group_posts")
}

model GroupPostLike {
  id        String    @id @default(cuid())
  postId    String    @map("post_id")
  post      GroupPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now()) @map("created_at")

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("group_post_likes")
}

model GroupPostComment {
  id        String    @id @default(cuid())
  postId    String    @map("post_id")
  post      GroupPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String    @db.Text
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([postId])
  @@index([userId])
  @@map("group_post_comments")
}

model GroupMessage {
  id        String   @id @default(cuid())
  groupId   String   @map("group_id")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  senderId  String   @map("sender_id")
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  message   String?  @db.Text
  imageUrl  String?  @map("image_url")
  catchId   String?  @map("catch_id")
  catch     Catch?   @relation(fields: [catchId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([groupId, createdAt])
  @@index([senderId])
  @@map("group_messages")
}

// ==================== NEW FEATURES ====================

// Favorite Spots Management
model FavoriteSpot {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  description      String?  @db.Text
  latitude         Float
  longitude        Float
  fishSpecies      String?  @map("fish_species") // Target fish species
  bottomType       String?  @map("bottom_type") // Bottom conditions
  depth            Float?   // Depth in meters
  parkingLatitude  Float?   @map("parking_latitude") // Parking location latitude
  parkingLongitude Float?   @map("parking_longitude") // Parking location longitude
  privacy          String   @default("private") // 'public', 'groups', 'friends', 'private'
  notes            String?  @db.Text // Private notes about the spot
  rating           Int?     // 1-5 stars
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([latitude, longitude])
  @@index([privacy])
  @@map("favorite_spots")
}

// Trip Planning
model Trip {
  id           String            @id @default(cuid())
  ownerId      String            @map("owner_id")
  owner        User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  title        String
  description  String?           @db.Text
  startDate    DateTime          @map("start_date")
  endDate      DateTime          @map("end_date")
  latitude     Float?
  longitude    Float?
  location     String?
  packingList  String?           @db.Text // JSON array
  isPublic     Boolean           @default(false) @map("is_public")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  participants TripParticipant[]

  @@index([ownerId])
  @@index([startDate])
  @@map("trips")
}

model TripParticipant {
  id        String   @id @default(cuid())
  tripId    String   @map("trip_id")
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("invited") // 'invited', 'accepted', 'declined'
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
  @@map("trip_participants")
}

// Gear Management
model Gear {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // 'rod', 'reel', 'lure', 'line', 'hook', 'other'
  brand       String?
  model       String?
  name        String
  description String?  @db.Text
  purchaseDate DateTime? @map("purchase_date")
  price       Float?
  imageUrl    String?  @map("image_url")
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([type])
  @@map("gear")
}

// Species Database
model Species {
  id              String   @id @default(cuid())
  name            String   @unique
  scientificName  String?  @map("scientific_name")
  description     String?  @db.Text
  minLegalSize    Float?   @map("min_legal_size") // cm
  closedSeasons   String?  @db.Text @map("closed_seasons") // JSON array
  bestBait        String?  @db.Text @map("best_bait")
  bestTechniques  String?  @db.Text @map("best_techniques")
  habitat         String?  @db.Text
  imageUrl        String?  @map("image_url")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("species")
}

// Fishing Licenses
model FishingLicense {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String    // 'annual', 'daily', 'weekly', etc.
  region      String
  issueDate   DateTime  @map("issue_date")
  expiryDate  DateTime  @map("expiry_date")
  licenseNumber String? @map("license_number")
  notes       String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([expiryDate])
  @@map("fishing_licenses")
}

// Challenges & Competitions
model Challenge {
  id           String                 @id @default(cuid())
  ownerId      String                 @map("owner_id")
  owner        User                   @relation("ownedChallenges", fields: [ownerId], references: [id], onDelete: Cascade)
  groupId      String?                @map("group_id")
  title        String
  description  String?                @db.Text
  type         String                 // 'most_catches', 'biggest_fish', 'total_weight', 'most_species'
  species      String?                // Filter by species
  startDate    DateTime               @map("start_date")
  endDate      DateTime               @map("end_date")
  isPublic     Boolean                @default(false) @map("is_public")
  prize        String?                @db.Text
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")
  participants ChallengeParticipant[]
  comments     ChallengeComment[]

  @@index([ownerId])
  @@index([startDate, endDate])
  @@map("challenges")
}

model ChallengeParticipant {
  id          String    @id @default(cuid())
  challengeId String    @map("challenge_id")
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  user        User      @relation("challengeParticipants", fields: [userId], references: [id], onDelete: Cascade)
  score       Float     @default(0) // Calculated based on challenge type
  rank        Int?
  joinedAt    DateTime  @default(now()) @map("joined_at")

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
  @@map("challenge_participants")
}

// Streaks & Gamification
model Streak {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          String   // 'daily_catch', 'weekly_active'
  currentStreak Int      @default(0) @map("current_streak")
  longestStreak Int      @default(0) @map("longest_streak")
  lastActiveDate DateTime @map("last_active_date")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([userId, type])
  @@index([userId])
  @@map("streaks")
}

// Smart Notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // 'weather_alert', 'spot_reminder', 'challenge_update', 'badge_earned', etc.
  title     String
  message   String   @db.Text
  data      String?  @db.Text // JSON data
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Challenge Comments (Chat)
model ChallengeComment {
  id          String    @id @default(cuid())
  challengeId String    @map("challenge_id")
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  text        String    @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([challengeId, createdAt])
  @@index([userId])
  @@map("challenge_comments")
}

// Private Messaging
model Message {
  id         String   @id @default(cuid())
  senderId   String   @map("sender_id")
  sender     User     @relation("sentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String   @map("receiver_id")
  receiver   User     @relation("receivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  text       String   @db.Text
  imageUrl   String?  @map("image_url")
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, isRead])
  @@map("messages")
}

// Personal Bests Tracking
model PersonalBest {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  species   String
  category  String   // 'length', 'weight'
  value     Float    // The record value
  unit      String   // 'cm', 'kg'
  date      DateTime // When the record was set
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, species, category])
  @@index([userId])
  @@index([species])
  @@map("personal_bests")
}

// Weather Data for Catches
model WeatherData {
  id          String   @id @default(cuid())
  catchId     String   @unique @map("catch_id")
  catch       Catch    @relation(fields: [catchId], references: [id], onDelete: Cascade)
  temperature Float?   // Celsius
  windSpeed   Float?   // km/h
  windDirection String? // N, NE, E, SE, S, SW, W, NW
  pressure    Float?   // hPa
  humidity    Float?   // %
  conditions  String?  // 'clear', 'cloudy', 'rainy', etc.
  moonPhase   String?  // 'new', 'waxing_crescent', 'first_quarter', 'waxing_gibbous', 'full', 'waning_gibbous', 'last_quarter', 'waning_crescent'
  tideState   String?  // 'high', 'low', 'rising', 'falling'
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([catchId])
  @@map("weather_data")
}

// Challenge Templates
model ChallengeTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  type        String   // 'most_catches', 'biggest_fish', 'total_weight', 'most_species'
  duration    Int      // Duration in days
  isPublic    Boolean  @default(true) @map("is_public")
  icon        String?  // Icon identifier
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("challenge_templates")
}
